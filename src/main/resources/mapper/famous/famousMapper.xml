<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.mapper.FamousMapper">



	<resultMap type="com.pcwk.ehr.famous.domain.FamousVO"
		id="famousMap">
		<id column="famous_sid" property="famousSid" />
		<result column="famous_author" property="famousAuthor" />
		<result column="famous_content" property="famousContent" />
		<result column="famous_emotion" property="famousEmotion" />
		<result column="famous_viewcount" property="famousViewcount" />
		<result column="famous_reccount" property="famousReccount" />
		<result column="famous_time" property="famousTime" />
		<result column="reg_id" property="regId" />
		<result column="total_cnt" property="totalCnt" />

		<association property="userVO"
			javaType="com.pcwk.ehr.user.domain.UserVO">
			<result property="nickname" column="nickname" />
		</association>

	</resultMap>


	<!-- 명언 베스트 3 추출 -->
<select id="getBest3" resultMap="famousMap">
    SELECT *
    FROM (
        SELECT f.*, m.nickname 
        FROM famous_collection f
        LEFT JOIN users m ON f.reg_id = m.user_id 
        WHERE f.famous_reccount <![CDATA[>]]> 0
        ORDER BY f.famous_reccount DESC, f.famous_time DESC 
    )
    WHERE ROWNUM <![CDATA[<=]]> 3
</select>

	<!-- 명언 전체 리스트 조회(페이징) -->
	<sql id="searchCondition">
		<where>
			<if test="searchWord != null and searchWord != ''">
				<choose>
					<when test="searchDiv == '10'"> AND famous_content LIKE '%' || #{searchWord} ||
						'%' </when>
					<when test="searchDiv == '20'"> AND famous_author LIKE '%' || #{searchWord} || '%'
					</when>
				</choose>
			</if>
		</where>
	</sql>

<select id="allDoRetrieve" parameterType="com.pcwk.ehr.cmn.DTO" resultMap="famousMap">
    SELECT A.*, B.total_cnt
    FROM (
        SELECT tt1.*
        FROM (
            SELECT ROWNUM AS rnum, t1.* FROM (
                SELECT f.*, m.nickname 
                FROM famous_collection f
                LEFT JOIN users m ON f.reg_id = m.user_id 
                WHERE 1=1
                <if test="searchWord != null and searchWord != ''">
                    <choose>
                        <when test="searchDiv == '10'"> AND f.famous_content LIKE '%' || #{searchWord} || '%' </when>
                        <when test="searchDiv == '20'"> AND f.famous_author LIKE '%' || #{searchWord} || '%' </when>
                    </choose>
                </if>
                ORDER BY f.famous_time DESC -- 최신순 정렬
            ) t1
            WHERE ROWNUM <![CDATA[ <= ]]> (#{pageNo} * #{pageSize})
        ) tt1
        WHERE tt1.rnum <![CDATA[ >= ]]> ((#{pageNo} - 1) * #{pageSize} + 1)
    ) A
    CROSS JOIN (
        SELECT COUNT(*) total_cnt 
        FROM famous_collection
        <where>
            <if test="searchWord != null and searchWord != ''">
                <choose>
                    <when test="searchDiv == '10'"> AND famous_content LIKE '%' || #{searchWord} || '%' </when>
                    <when test="searchDiv == '20'"> AND famous_author LIKE '%' || #{searchWord} || '%' </when>
                </choose>
            </if>
        </where>
    ) B
</select>

	<!-- 1건 저장 -->
	<insert id="doSave"
		parameterType="com.pcwk.ehr.famous.domain.FamousVO">
		INSERT INTO famous_collection (
		famous_sid,
		famous_author,
		famous_content,
		famous_emotion,
		famous_viewcount,
		famous_reccount,
		famous_time,
		famous_update,
		reg_id
		) VALUES (
		famous_seq.NEXTVAL,
		#{famousAuthor},
		#{famousContent},
		#{famousEmotion},
		0,
		0,
		SYSDATE,
		SYSDATE,
		#{regId}
		)
	</insert>
	<insert id="saveAll">
		INSERT INTO famous_collection (
		famous_sid,
		famous_author,
		famous_content,
		famous_emotion,
		famous_viewcount,
		famous_reccount,
		famous_time,
		famous_update,
		reg_id
		)
		SELECT
		famous_seq.NEXTVAL AS
		famous_sid,
		'작가' || LEVEL AS famous_author,
		'명언 내용' || LEVEL AS
		famous_content,
		'P' AS famous_emotion,
		LEVEL AS famous_viewcount,
		0 AS
		famous_reccount,
		SYSDATE AS famous_time,
		SYSDATE AS famous_update,
		'user01' AS reg_id
		FROM dual
		CONNECT BY LEVEL <![CDATA[ <= ]]>
		1002
	</insert>



	<!-- famousSid로 특정 명언 1건 조회 -->
<select id="doSelectOne" resultType="com.pcwk.ehr.famous.domain.FamousVO">
    SELECT 
        T1.famous_sid as famousSid,
        T1.famous_author as famousAuthor,
        T1.famous_content as famousContent,
        T1.famous_emotion as famousEmotion,
        T1.famous_viewcount as famousViewcount,
        T1.famous_reccount as famousReccount,
        T1.famous_time as famousTime,
        T1.reg_id as regId,
        T2.nickname as nickname  FROM famous_collection T1
    LEFT OUTER JOIN users T2 ON T1.reg_id = T2.user_id 
    WHERE T1.famous_sid = #{famousSid}
</select>

	<select id="doRetrieve" parameterType="com.pcwk.ehr.cmn.DTO"
		resultMap="famousMap">
		SELECT A.*, B.*
		FROM (
		SELECT tt1.rnum AS no,
		tt1.famous_sid AS famousSid,
		tt1.famous_author AS famousAuthor,
		tt1.famous_content AS famousContent,
		tt1.famous_emotion AS famousEmotion,
		tt1.famous_viewcount AS famousViewcount,
		tt1.famous_reccount AS famousReccount,
		tt1.famous_time AS famousTime,
		tt1.reg_id AS regId
		FROM (
		SELECT ROWNUM AS rnum, t1.*
		FROM (
		SELECT *
		FROM famous_collection WHERE 1=1
		ORDER BY famous_time DESC
		) t1
		WHERE ROWNUM <![CDATA[ <= ]]>
		(#{pageSize} * (#{pageNo} - 1) + #{pageSize})
		) tt1
		WHERE tt1.rnum <![CDATA[ >= ]]>
		(#{pageSize} * (#{pageNo} - 1) + 1)
		) A
		CROSS JOIN (
		SELECT COUNT(*) total_cnt FROM famous_collection
		) B
	</select>

	<!-- 명언 전체 건수(숫자) 조회 -->
	<select id="getCount" resultType="int">
		SELECT COUNT(*) FROM
		famous_collection
	</select>

	<!-- 명언 전체 목록 조회(전체 데이터)_최신 명언 위로 -->
	<select id="getAll" resultMap="famousMap">
		SELECT
		famous_sid,
		famous_author,
		famous_content,
		famous_emotion,
		famous_viewcount,
		famous_reccount,
		famous_time,
		reg_id
		FROM famous_collection
		ORDER BY famous_sid DESC
	</select>


	<!-- 명언 1건 수정 -->
	<update id="doUpdate"
		parameterType="com.pcwk.ehr.famous.domain.FamousVO">
		UPDATE famous_collection
		SET
		famous_author = #{famousAuthor},
		famous_content = #{famousContent},
		famous_emotion = #{famousEmotion}
		WHERE famous_sid = #{famousSid}
	</update>




	<!-- 조회수 증가 -->
	<update id="updateViewCount"
		parameterType="com.pcwk.ehr.famous.domain.FamousVO">
		UPDATE famous_collection
		SET famous_viewcount = NVL(famous_viewcount, 0) + 1
		WHERE famous_sid = #{famousSid}
	</update>

	<!-- 추천수 증가 -->
	<update id="updateReCount"
		parameterType="com.pcwk.ehr.famous.domain.FamousVO">
		UPDATE famous_collection
		SET famous_reccount =
		famous_reccount + #{famousReccount}
		WHERE famous_sid = #{famousSid}
	</update>

<select id="getFamousDetail" parameterType="com.pcwk.ehr.famous.domain.FamousVO">
    SELECT
        famous_sid AS famousSid,
        famous_author AS famousAuthor,
        famous_content AS famousContent,
        famous_emotion AS famousEmotion,
        famous_viewcount AS famousViewcount,
        famous_reccount AS famousReccount,
        reg_id AS regId,
        TO_CHAR(famous_time, 'YYYY-MM-DD HH24:MI:SS') AS famousTime
        FROM famous_collection
    WHERE famous_sid = #{famousSid}
</select>

	<!-- 명언 1건 삭제 -->
	<delete id="doDelete"
		parameterType="com.pcwk.ehr.famous.domain.FamousVO">
		DELETE FROM famous_collection
		WHERE famous_sid =
		#{famousSid}
	</delete>

	<update id="doUpdateRecTime"
		parameterType="com.pcwk.ehr.user.domain.UserVO">
		UPDATE users
		SET last_rec_time = SYSDATE
		WHERE user_id = #{userId}
	</update>


	<!-- 전체 삭제 _테스트용 -->
	<delete id="deleteAll">
		DELETE FROM famous_collection
	</delete>

	<!-- 감정(P/N)별 랜덤 명언 1개 조회 -->
	<select id="getRandomByEmotion" parameterType="string" resultMap="famousMap">
		SELECT * FROM (
			SELECT * FROM famous_collection
			WHERE famous_emotion = #{famousEmotion}
			ORDER BY dbms_random.value
		) WHERE ROWNUM = 1
	</select>

	<select id="getById" parameterType="int" resultType="com.pcwk.ehr.famous.domain.FamousVO">
  		SELECT * FROM famous_collection WHERE famous_sid = #{famousSid}
	</select>




</mapper>